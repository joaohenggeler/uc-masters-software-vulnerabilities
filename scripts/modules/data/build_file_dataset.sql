SET @ALERT_COLUMNS = NULL;
SET @ALERT_COUNT = NULL;
SET @QUERY = NULL;

SET @@group_concat_max_len = 100000;

SELECT
	GROUP_CONCAT(CONCAT('IFNULL(`', FEATURE_NAME, '`, 0) AS `', FEATURE_NAME, '`')),
	GROUP_CONCAT(
		CONCAT(	'COUNT(CASE WHEN SAT_NAME = \'', SAT_NAME, '\'',
				' AND RULE_NAME = \'', RULE_NAME, '\'',
				' THEN 1 END) AS `', FEATURE_NAME, '`')
	)
INTO @ALERT_COLUMNS, @ALERT_COUNT
FROM
(
	SELECT SAT_NAME, RULE_NAME, CONCAT(REPLACE(SAT_NAME, ' ', ''), '_', REPLACE(RULE_NAME, ' ', '')) AS FEATURE_NAME
    FROM RULE AS R INNER JOIN SAT S ON R.SAT_ID = S.SAT_ID
	GROUP BY SAT_NAME, RULE_NAME
) SAT_RULE;

SET @QUERY = CONCAT(
	'SELECT U.*, IFNULL(A.TOTAL_ALERTS, 0) AS TOTAL_ALERTS, ', @ALERT_COLUMNS,
    'FROM FILES_3 AS U LEFT JOIN
	(
		SELECT ID_File, COUNT(*) AS TOTAL_ALERTS,',
        @ALERT_COUNT,
		'FROM ALERT A
		INNER JOIN RULE R ON A.RULE_ID = R.RULE_ID
		INNER JOIN SAT S ON R.SAT_ID = S.SAT_ID
		GROUP BY ID_File
	) A ON U.ID_File = A.ID_File
	LIMIT 100;'
);

PREPARE STATEMENT FROM @QUERY;
EXECUTE STATEMENT;
DEALLOCATE PREPARE STATEMENT;